name: Dependabot Auto Merge

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]

permissions:
  contents: write
  pull-requests: write

jobs:
  merge:
    if: github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: Merge Dependabot PR after successful CI
        uses: actions/github-script@v8
        with:
          script: |
            const { owner, repo } = context.repo;
            const prs = context.payload.workflow_run.pull_requests || [];

            if (prs.length === 0) {
              core.info("No pull request associated with this workflow run.");
              return;
            }

            for (const prRef of prs) {
              const prNumber = prRef.number;
              const { data: pr } = await github.rest.pulls.get({
                owner,
                repo,
                pull_number: prNumber,
              });

              if (pr.user.login !== "dependabot[bot]") {
                core.info(`PR #${prNumber} is not from Dependabot, skipping.`);
                continue;
              }

              if (pr.state !== "open" || pr.draft) {
                core.info(`PR #${prNumber} is not mergeable now, skipping.`);
                continue;
              }

              await github.rest.pulls.merge({
                owner,
                repo,
                pull_number: prNumber,
                merge_method: "squash",
              });

              core.info(`Merged Dependabot PR #${prNumber}.`);
            }
